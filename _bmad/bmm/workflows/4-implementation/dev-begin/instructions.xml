<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language}</critical>
  <critical>Execute ALL steps in exact order; do NOT skip steps</critical>
  <critical>This is an AUTONOMOUS workflow - make decisions automatically based on project state</critical>
  <critical>INFORM the user of decisions, do NOT ask for input except in Step 1 (uncommitted changes)</critical>

  <step n="1" goal="Verify git state and handle uncommitted changes">
    <critical>Ensure clean working tree before proceeding</critical>

    <!-- Check for uncommitted changes -->
    <action>Run: git status --porcelain</action>

    <check if="working tree has uncommitted changes">
      <output>**Uncommitted Changes Detected**

You have uncommitted changes in your working tree.

**Options:**
1. Stash changes (git stash push -m "dev-begin auto-stash")
2. Commit changes (will prompt for message)
3. Discard changes (git checkout -- . &amp;&amp; git clean -fd)
4. Abort workflow
      </output>
      <ask>How would you like to proceed? [1/2/3/4]:</ask>

      <check if="user chooses '1'">
        <action>Run: git stash push -m "dev-begin auto-stash"</action>
        <output>Changes stashed. Remember to `git stash pop` later.</output>
      </check>
      <check if="user chooses '2'">
        <ask>Enter commit message:</ask>
        <action>Run: git add -A &amp;&amp; git commit -m "{{user_commit_message}}"</action>
      </check>
      <check if="user chooses '3'">
        <ask>Are you sure you want to discard all changes? This cannot be undone. [y/n]</ask>
        <action if="confirmed">Run: git checkout -- . &amp;&amp; git clean -fd</action>
      </check>
      <check if="user chooses '4'">
        <action>HALT: "Workflow aborted by user due to uncommitted changes"</action>
      </check>
    </check>

    <check if="working tree is clean">
      <output>Working tree is clean.</output>
    </check>
  </step>

  <step n="2" goal="Determine target story">
    <critical>Resolve which story to work on through auto-detection or user input</critical>

    <!-- Check if story_id was provided -->
    <check if="{{story_id}} is provided and not empty">
      <output>Using provided story ID: **{{story_id}}**</output>
      <action>Set {{target_story_id}} = {{story_id}}</action>
      <goto anchor="find_story_file" />
    </check>

    <!-- Check current branch -->
    <action>Run: git branch --show-current</action>
    <action>Store result as {{current_branch}}</action>

    <!-- Check if on a story branch -->
    <check if="{{current_branch}} matches pattern 'story/*'">
      <action>Extract story-id from branch name (story/X-Y-slug -> X-Y)</action>
      <action>Store as {{target_story_id}}</action>
      <output>Detected story from branch: **{{target_story_id}}**</output>
      <goto anchor="find_story_file" />
    </check>

    <!-- Check if in a worktree directory -->
    <action>Run: pwd</action>
    <action>Check if current directory is under {worktree_base}/story-*</action>
    <check if="in worktree directory">
      <action>Extract story-id from worktree path</action>
      <action>Store as {{target_story_id}}</action>
      <output>Detected story from worktree: **{{target_story_id}}**</output>
      <action>Set {{in_existing_worktree}} = true</action>
      <goto anchor="find_story_file" />
    </check>

    <!-- On staging or unknown branch - find next ready-for-dev story -->
    <output>On **{{current_branch}}** - searching for next ready-for-dev story...</output>

    <check if="{{sprint_status}} file exists">
      <action>Load the FULL file: {{sprint_status}}</action>
      <action>Find the FIRST story where status == "ready-for-dev"</action>

      <check if="ready-for-dev story found">
        <action>Store story key as {{target_story_id}}</action>
        <output>Found next story: **{{target_story_id}}**</output>
      </check>

      <check if="no ready-for-dev story found">
        <output>**No Ready Stories**

No stories with status "ready-for-dev" found in sprint-status.yaml.

**Options:**
1. Run `create-story` workflow to create the next story
2. Specify a story ID manually
        </output>
        <action>HALT: "No ready-for-dev stories available"</action>
      </check>
    </check>

    <check if="{{sprint_status}} file does NOT exist">
      <output>**Sprint Status Not Found**

Cannot find sprint-status.yaml at: {{sprint_status}}

Please ensure sprint tracking is set up or provide a story ID directly.
      </output>
      <action>HALT: "Sprint status file not found"</action>
    </check>

    <anchor id="find_story_file" />

    <!-- Locate the story file -->
    <action>Search {story_dir} for file matching pattern: {{target_story_id}}*.md</action>

    <check if="story file found">
      <action>Store full path as {{story_path}}</action>
      <action>Read COMPLETE story file</action>
      <output>Loaded story file: {{story_path}}</output>
    </check>

    <check if="story file NOT found">
      <output>**Story File Not Found**

Could not find story file for: {{target_story_id}}
Searched in: {story_dir}
      </output>
      <action>HALT: "Story file not found"</action>
    </check>
  </step>

  <step n="3" goal="Validate story state">
    <critical>Check if story is in a valid state for development work</critical>

    <!-- Get story status from sprint-status.yaml -->
    <action>Load {{sprint_status}} file</action>
    <action>Find status for {{target_story_id}}</action>
    <action>Store as {{story_status}}</action>

    <output>Story **{{target_story_id}}** status: **{{story_status}}**</output>

    <!-- Handle done/review status -->
    <check if="{{story_status}} == 'done' OR {{story_status}} == 'review'">
      <output>Story is in **{{story_status}}** state - checking if merged...</output>

      <!-- Check if merged to staging -->
      <action>Run: git fetch origin staging</action>
      <action>Run: git branch -r --merged origin/staging | grep -E "story/{{target_story_id}}" || echo "not-merged"</action>

      <check if="branch is merged to staging">
        <output>Story **{{target_story_id}}** is complete and merged. Finding next story...</output>
        <action>Set {{story_id}} = empty</action>
        <action>Set {{target_story_id}} = empty</action>
        <goto step="2">Find next ready-for-dev story</goto>
      </check>

      <check if="branch is NOT merged to staging">
        <output>**Story Complete But Not Merged**

Story **{{target_story_id}}** is marked as **{{story_status}}** but the branch has not been merged to staging.

Please merge your PR first, then run dev-begin again.
        </output>
        <action>HALT: "Story complete but branch not merged. Merge PR first."</action>
      </check>
    </check>

    <!-- Handle in-progress status -->
    <check if="{{story_status}} == 'in-progress'">
      <output>Story is **in-progress** - will resume existing work</output>
      <action>Set {{is_resume}} = true</action>
    </check>

    <!-- Handle ready-for-dev status -->
    <check if="{{story_status}} == 'ready-for-dev'">
      <output>Story is **ready-for-dev** - will set up fresh environment</output>
      <action>Set {{is_resume}} = false</action>
    </check>

    <!-- Handle unexpected status -->
    <check if="{{story_status}} is not 'done', 'review', 'in-progress', or 'ready-for-dev'">
      <output>**Unexpected Story Status**

Story **{{target_story_id}}** has status: **{{story_status}}**
Expected one of: ready-for-dev, in-progress, review, done
      </output>
      <action>HALT: "Unexpected story status"</action>
    </check>
  </step>

  <step n="4" goal="Check story dependencies">
    <critical>Verify all dependencies are complete before starting work</critical>
    <critical>If ANY dependency is not done, STOP the workflow</critical>

    <!-- Parse Depends On section from story file -->
    <action>Parse story file for "Depends On:" section</action>
    <action>Extract list of dependency story IDs</action>
    <action>Store as {{dependencies}}</action>

    <check if="{{dependencies}} is empty or not present">
      <output>No dependencies - proceeding</output>
      <goto step="5" />
    </check>

    <output>**Checking Dependencies...**</output>

    <!-- Check each dependency -->
    <action>For each dependency in {{dependencies}}:</action>
    <action>  - Look up status in {{sprint_status}}</action>
    <action>  - Store incomplete dependencies in {{incomplete_deps}}</action>

    <check if="{{incomplete_deps}} is NOT empty">
      <output>**Cannot Start Story - Dependencies Incomplete**

Story **{{target_story_id}}** depends on stories that are not yet done:

{{incomplete_deps_formatted}}

Please complete the above stories first, then run dev-begin again.
      </output>
      <action>HALT: "Dependencies not complete"</action>
    </check>

    <check if="all dependencies are done">
      <output>All dependencies complete</output>
    </check>
  </step>

  <step n="5" goal="Decide environment type (worktree vs branch)">
    <critical>Decision is based on "Can Parallel With" section in story file</critical>
    <critical>If Can Parallel With has ANY entries -> WORKTREE</critical>
    <critical>If Can Parallel With is empty -> BRANCH</critical>

    <!-- Check for resume mode first -->
    <check if="{{is_resume}} == true">
      <output>**Resume Mode** - checking for existing environment...</output>
      <goto anchor="resume_check" />
    </check>

    <!-- Fresh start - check Can Parallel With -->
    <action>Parse story file for "Can Parallel With:" section</action>
    <action>Extract list of parallel story IDs</action>
    <action>Store as {{can_parallel_with}}</action>

    <check if="{{can_parallel_with}} is NOT empty">
      <action>Set {{environment_type}} = "worktree"</action>
      <output>**Environment Decision: WORKTREE**
Reason: Story can be parallelized with: {{can_parallel_with}}
      </output>

      <!-- Check for existing parallel worktrees (informational) -->
      <action>Run: ls -d {worktree_base}/story-* 2>/dev/null || echo "none"</action>
      <check if="parallel worktrees exist">
        <output>Active parallel worktrees detected: {{existing_worktrees}}</output>
      </check>
    </check>

    <check if="{{can_parallel_with}} is empty">
      <action>Set {{environment_type}} = "branch"</action>
      <output>**Environment Decision: BRANCH**
Reason: Story has no parallel siblings
      </output>
    </check>

    <goto step="6" />

    <!-- Resume mode: find existing environment -->
    <anchor id="resume_check" />

    <!-- Check for existing worktree -->
    <action>Check if {worktree_base}/story-{{target_story_id}}/ exists</action>
    <check if="worktree exists">
      <action>Set {{environment_type}} = "worktree"</action>
      <action>Set {{environment_path}} = {worktree_base}/story-{{target_story_id}}</action>
      <output>**Resume Mode: Existing worktree found**
Path: {{environment_path}}
      </output>
      <goto step="6" />
    </check>

    <!-- Check if already on the story branch -->
    <check if="{{current_branch}} == 'story/{{target_story_id}}'">
      <action>Set {{environment_type}} = "branch"</action>
      <output>**Resume Mode: Already on story branch**
Branch: {{current_branch}}
      </output>
      <goto step="6" />
    </check>

    <!-- Check if story branch exists but not checked out -->
    <action>Run: git branch --list "story/{{target_story_id}}"</action>
    <check if="branch exists">
      <action>Set {{environment_type}} = "branch"</action>
      <action>Set {{needs_checkout}} = true</action>
      <output>**Resume Mode: Story branch exists**
Branch: story/{{target_story_id}}
      </output>
      <goto step="6" />
    </check>

    <!-- No existing environment found for in-progress story - error -->
    <output>**Error: In-Progress Story Without Environment**

Story **{{target_story_id}}** is marked in-progress but no branch or worktree was found.

This may indicate a corrupted state. Please check git branches and worktrees manually.
    </output>
    <action>HALT: "In-progress story has no environment"</action>
  </step>

  <step n="6" goal="Set up development environment">
    <critical>Create worktree or branch based on decision from Step 5</critical>
    <critical>For fresh starts, always pull latest from staging first</critical>

    <!-- Resume mode shortcuts -->
    <check if="{{is_resume}} == true AND {{in_existing_worktree}} == true">
      <output>**Already in worktree** - no setup needed</output>
      <goto step="7" />
    </check>

    <check if="{{is_resume}} == true AND {{environment_type}} == 'worktree'">
      <output>Switching to existing worktree...</output>
      <action>Change working directory to: {{environment_path}}</action>
      <output>Now in: {{environment_path}}</output>
      <goto step="7" />
    </check>

    <check if="{{is_resume}} == true AND {{needs_checkout}} == true">
      <output>Checking out existing branch...</output>
      <action>Run: git checkout story/{{target_story_id}}</action>
      <output>Switched to branch: story/{{target_story_id}}</output>
      <goto step="7" />
    </check>

    <check if="{{is_resume}} == true AND {{environment_type}} == 'branch'">
      <output>**Already on story branch** - no setup needed</output>
      <goto step="7" />
    </check>

    <!-- Fresh start: ensure we're on staging with latest -->
    <output>Setting up fresh environment...</output>

    <check if="{{current_branch}} != 'staging'">
      <action>Run: git checkout staging</action>
      <output>Switched to staging</output>
    </check>

    <action>Run: git pull origin staging</action>
    <output>Pulled latest from staging</output>

    <!-- Create worktree -->
    <check if="{{environment_type}} == 'worktree'">
      <action>Run: mkdir -p {worktree_base}</action>
      <action>Run: git worktree add {worktree_base}/story-{{target_story_id}} -b story/{{target_story_id}}</action>

      <check if="git worktree command fails">
        <output>**Git Worktree Creation Failed**

Common causes:
- Branch 'story/{{target_story_id}}' already exists locally or remotely
- Worktree directory already exists at {worktree_base}/story-{{target_story_id}}

**Troubleshooting:**
- Check existing worktrees: `git worktree list`
- Check existing branches: `git branch -a | grep {{target_story_id}}`
- Remove stale worktree: `git worktree remove {worktree_base}/story-{{target_story_id}}`
        </output>
        <action>HALT: "Worktree creation failed - see troubleshooting above"</action>
      </check>

      <action>Set {{environment_path}} = {worktree_base}/story-{{target_story_id}}</action>

      <!-- Copy gitignored config files to new worktree -->
      <check if="{project-root}/.codex/auth.json exists">
        <action>Run: mkdir -p {{environment_path}}/.codex</action>
        <action>Run: cp {project-root}/.codex/auth.json {{environment_path}}/.codex/auth.json</action>
        <output>Copied .codex/auth.json to worktree</output>
      </check>

      <output>**Worktree Created**
Path: {{environment_path}}
Branch: story/{{target_story_id}}
      </output>
      <action>Change working directory to: {{environment_path}}</action>
      <output>Now in: {{environment_path}}</output>
    </check>

    <!-- Create branch -->
    <check if="{{environment_type}} == 'branch'">
      <action>Run: git checkout -b story/{{target_story_id}}</action>
      <output>**Branch Created**
Branch: story/{{target_story_id}}
      </output>
    </check>
  </step>

  <step n="7" goal="Invoke dev-story workflow">
    <critical>Hand off to dev-story with all context</critical>

    <!-- Determine mode display text -->
    <check if="{{is_resume}} == true">
      <action>Set {{mode_display}} = "Resume"</action>
    </check>
    <check if="{{is_resume}} == false">
      <action>Set {{mode_display}} = "Fresh Start"</action>
    </check>

    <output>
**Environment Ready**

| Setting | Value |
|---------|-------|
| Story | {{target_story_id}} |
| Story File | {{story_path}} |
| Environment | {{environment_type}} |
| Mode | {{mode_display}} |

**Starting dev-story workflow...**
    </output>

    <!-- Update sprint status to in-progress if it was ready-for-dev -->
    <check if="{{story_status}} == 'ready-for-dev'">
      <action>Update {{sprint_status}}: set {{target_story_id}} status to "in-progress"</action>
      <output>Sprint status updated: ready-for-dev -> in-progress</output>
    </check>

    <!-- Invoke dev-story -->
    <action>Load and execute {dev_story_workflow}/workflow.yaml with:
      - story_file: {{story_path}}
      - story_id: {{target_story_id}}
    </action>
  </step>

</workflow>
